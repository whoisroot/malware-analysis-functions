#!/bin/bash

# Variables
export XMLLINT_INDENT="    "
export color="1;4;36"
export CSS_file="$HOME/.relatorios.css"

function dwg_macro(){
	IFS_bkp=$IFS
	IFS=$'\n'
	for arquivo in $(find . -iname "*.dwg"); do
		if [[ -n $(xxd -p "${arquivo}" | tr -d "\n" | grep -i d0cf11e0) ]]; then
			echo "❗ O arquivo ${arquivo} 📄 contém um OLE 📦 embutido ❗" # This file contains an OLE container embedded
		fi
	done
	IFS=$IFS_bkp
}

function OLEpuke(){
	if [[ $DEBUG ]]; then
		echo "🎨 Color: ${color}" >&2
	fi
	IFS_bkp=$IFS
	IFS=$'\n'
	for ole in $(find . -type f -exec file "{}" \; | egrep "Composite Document File V2 Document|Microsoft (Word|Excel|PowerPoint)" | cut -d: -f1); do
		if [[ $DEBUG ]]; then
			echo "📦 ${ole}" >&2
		fi
		if [[ $1 == "--short" ]]; then
			if [[ $(oleid "${ole}" | cut -d"|" -f3 | egrep "HIGH|Medium") ]]; then
				oleid "${ole}";
			fi
		else
			echo -e "\n\n\e[${color}m$ole\e[0m\n";
			oleid "${ole}";
		fi
	done
	IFS=$IFS_bkp
}

function XMLpuke(){
	if [[ $DEBUG ]]; then
		echo "🎨 Color: ${color}" >&2
	fi
	IFS_bkp=$IFS
	IFS=$'\n'
	for xml in $(find . -type f -exec file \{\} \; | grep -i xml | cut -d: -f1); do
		if [[ $DEBUG ]]; then
			echo "🔖 ${xml}" >&2
		fi
		echo -e "\n\n🔖 \e[${color}m$xml\e[0m\n";
		XMLpretty "${xml}";
	done
	IFS=$IFS_bkp
}

function XMLpretty(){
	xmllint --format $@
}

function hashes(){
	if [[ $DEBUG ]]; then
		echo -e "🎨 Color: ${color}\n📄 File: ${1}" >&2
	fi
	if [[ -f "${1}" ]]; then
		echo -en "🔓 \e[${color}mMD5:\e[0m\t\t"; md5sum "$1" | cut -d" " -f1;
		echo -en "🔗 \e[${color}mSHA-1:\e[0m\t"; sha1sum "$1" | cut -d" " -f1;
		echo -en "✅ \e[${color}mSHA-256:\e[0m\t"; sha256sum "$1" | cut -d" " -f1;
	else
		echo "Você deve passar pelo menos um arquivo 🙄"; # You should supply at least one file
		return -1
	fi;
}

function multiple_hashes2report(){
	if [[ -z $@ ]]; then
		echo "Você deve passar pelo menos um arquivo 🙄" >&2; # You should supply at least one file
		return -1
	fi
	color_bkp="${color}"
	color=""
	for file in "$@"; do
		file_escaped="$(sed 's/_/\\_/g' <<< "${file}")"
		if [[ $DEBUG ]]; then
			echo -e "\n📄 File: ${file}\n📜 File escaped: ${file_escaped}" >&2
		fi
		if [[ -f "${1}" ]]; then
			echo -e "\n_${file_escaped}_"
			DEBUG="" hashes "${file}" | sed 's/^/\n\> /g' | sed 's/\x1b\[/**/g' | sed 's/0m\t\+/ \`/g' | sed 's/$/\`/g' | sed 's/^`$//g' | tr -d m
		fi
	done
	color="${color_bkp}"
	unset color_bkp
}

function meta(){
	if [[ -z $@ ]]; then
		echo "Você deve passar pelo menos um arquivo 🙄"; # You should supply at least one file
		return -1
	fi
	if [[ $DEBUG ]]; then
		echo -e "📚 Files: $@\n🎨 Color: ${color}" >&2
	fi
	for file in "$@"; do
		if [[ -f "$file" ]]; then
			python3 -c "print('\n'+'/\u203e\\_'*20+'/\n')" | lolcat
			echo -e "📄 \e[${color}mFile:\e[0m\t${file}";
			echo -en "💾 \e[${color}mSize:\e[0m\t"; du -sh "${file}" | cut -f1;
			echo -en "🔎 \e[${color}mFile type:\e[0m\t\x08"; file "${file}" | cut -d":" -f2-;
			DEBUG="" hashes "$file";
		fi
	done
	python3 -c "print('\n'+'/\u203e\\_'*20+'/\n')" | lolcat
}

function md2html(){
	if [[ $(grep -i ".md" <<< "$1") ]]; then
		doc="$(sed -r 's/\.(md|MD)//g' <<< "$1")"
	else
		doc="$1"
	fi
	pandoc -f gfm -t html5 -s --metadata title="Incidente $doc" --self-contained -c "$CSS_file" -o "$doc.html" "$doc.md"
	sed -i 's/<a href=".*">//g' "$doc.html" # Remove anchor links
	sed -i 's/<\/a>//g' "$doc.html" # Remove anchor tags
}

function b64d(){
	if [[ -n $1 ]]; then
		if [[ -f "$1" ]]; then
			base64 -d "$1" && echo
		else
			base64 -d <<< "${1}" && echo
		fi
	else
		base64 -d && echo
	fi
}

function b64(){
	if [[ -n $1 ]]; then
		if [[ -f "$1" ]]; then
			base64 "$1" && echo
		else
			base64 <<< "${1}" && echo;
		fi
	else
		base64 && echo;
	fi
}

function url_encode(){
	if [[ -z $1 ]]; then
		python3 -c "import urllib.parse;print('\n'+urllib.parse.quote(input())+'\n')"
	else
		python3 -c "import urllib.parse;print('\n'+urllib.parse.quote(input())+'\n')" <<< "${1}"
	fi
}

function url_decode(){
	if [[ -z $1 ]]; then
		python3 -c "import urllib.parse;print('\n'+urllib.parse.unquote(input())+'\n')"
	else
		python3 -c "import urllib.parse;print('\n'+urllib.parse.unquote(input())+'\n')" <<< "${1}"
	fi
}

function noNULLstrings(){
	cat "$1" | tr -d '\0' | strings
}

function urlSearch(){
	egrep -ao "(\w+\.)+[[:alpha:]]{2,5}(/|[[:space:]]|\")" "$1" | sort -u
}

function xxdNULL(){
	xxd -c 66 "$1" | cut -d: -f2- | egrep "00 ?00"
}

function ipinfo(){
	if [[ $DEBUG ]]; then
		echo -e "🔑 IPINFO_AUTH: ${IPINFO_AUTH}\n🌐 IP: ${1}\n📝 JSON fields: ${2}" >&2
	fi
	output=$(curl -s -u ${IPINFO_AUTH}: "https://ipinfo.io/${1}")
	emoji=$(python3 -c 'country=input();emoji=chr(ord(country[0])-0x41+0x0001F1E6)+chr(ord(country[1])-0x41+0x0001F1E6);print(emoji)' <<< $(jq -r .country <<< "$output"))
	output="$(jq --arg flag "$emoji" '. += {"country_flag": $flag}' <<< "$output")"
	jq "${2}" <<< "$output"
}

alias myip="ipinfo '' .ip | tr -d '\"'"

function limpa_safelinks(){
	python -c "print('✅'+'➰➿'*20+'➰⛔')"
	cut -d= -f2 <<< "$1" | cut -d\& -f1 | url_decode
	python -c "print('✅'+'➰➿'*20+'➰⛔')"
}

function get_redirects(){
	curl --head -s -L "$1" | grep -i location
}

function parse_lnks (){
	IFS_bkp=$IFS
	IFS=$'\n'
	for lnk in $@; do
		echo -e "\n$lnk\n - - -" | lolcat -a
		lnkparse "${lnk}" | egrep --color=auto "(Command line arguments|Primary name|Relative path|\w+ Timestamp):"
	done
	IFS=$IFS_bkp
}

alias LNKs="parse_lnks *.lnk"

function VT_query() {
	for file in "$@"; do
		python -c "print('\n'+'-='*20+'-')" | lolcat
		echo -e "\n${file}\n"
		hash=$(sha256sum "${file}" | cut -d" " -f1);
		curl -s --header "x-apikey: $VT_API_KEY"  https://www.virustotal.com/api/v3/files/${hash} | jq 'if (.error) then { "Error code": .error.code, Emotion: "🤷" } else { last_analysis_stats: .data.attributes.last_analysis_stats,popular_threat_category: .data.attributes.popular_threat_classification.popular_threat_category,popular_threat_name: .data.attributes.popular_threat_classification.popular_threat_name, last_analysis_date: .data.attributes.last_analysis_date | strftime("%B %d %Y %I:%M%p %Z") } end';
	done
	python -c "print('\n'+'-='*20+'-\n')" | lolcat
}

# https://github.com/sevsec/vt-scan
alias VT_scan_file="vt-scan -k "$VT_API_KEY" -f"
alias VT_scan_url="vt-scan -k "$VT_API_KEY" -u"
alias VT_scan_domain="vt-scan -k "$VT_API_KEY" -d"
alias VT_scan_ip="vt-scan -k "$VT_API_KEY" -i"

function VT_wait_analysis (){
	echo "Aguardando resultados da análise:" # Waiting the analysis results
	output="$(vt-scan -k "$VT_API_KEY" -a "$1")"
	while [[ "\"completed\"" != $(echo "$output" | jq '.data.attributes.status') ]]; do
		for i in {0..4}; do
			printf "🤔"
			sleep 2
		done
		printf "\b\b\b\b\b\b\b\b\b\b          \b\b\b\b\b\b\b\b\b\b"
		n="\n\n"
		output="$(vt-scan -k "$VT_API_KEY" -a "$1")"
	done
	echo -en "$n"; unset n
	curl -s --header "x-apikey: $VT_API_KEY" "$(jq -r '.data.links.item' <<< $output)" | jq '{ last_analysis_stats: .data.attributes.last_analysis_stats,popular_threat_category: .data.attributes.popular_threat_classification.popular_threat_category,popular_threat_name: .data.attributes.popular_threat_classification.popular_threat_name, last_analysis_date: .data.attributes.last_analysis_date | strftime("%B %d %Y %I:%M%p %Z") }'
}

function VT_submit-n-wait (){
	if [[ -z $1 ]]; then
		echo "Você deve passar pelo menos um arquivo 🙄"; # You should supply at least one file
		return -1
	fi
	submission="$(VT_scan_file $1)"
	if [[ $DEBUG ]]; then
		jq -C >&2 <<< $submission
	fi
	VT_wait_analysis $(jq -r .data.id <<< $submission)
}
